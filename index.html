        // チャットデータ (元のJavaScriptのchatDataをここにコピーしてください)
        const chatData = {
            initial: {
                bot: "こんにちは！キープオンスクールの案内役、センサーです。\n\n私たちのスクールに興味を持っていただき、ありがとうございます！\n\nキープオンについて、どんなことが知りたいですか？",
                questions: [
                    { id: 'about', text: 'どんなスクールなの？' },
                    { id: 'enjoy', text: 'うちの子でも楽しめる？' },
                    { id: 'beginner', text: 'プログラミング未経験でも大丈夫？' },
                    { id: 'skills', text: 'どんな力が身につくの？' }
                ]
            },
            about: {
                user: "どんなスクールなの？",
                bot: "キープオンは、ただプログラミングを教えるだけのスクールではありません。\n\n私たちの最大の特徴は「正解のない問いを楽しむ」ことです。\n\n社会には正解がひとつではない場面がたくさんありますよね。そんな時に、自分で考えて、自分で選択して、自分で行動できる「自律型人材」を育てることが私たちの目標です。\n\nロボット製作やプログラミングを通じて、身近なもの（信号機や自動ドアなど）の仕組みを学び、そこに自分のアイデアを加えて、オリジナルの作品を作っていきます。",
                questions: [
                    { id: 'different', text: '他のスクールとの違いは？' },
                    { id: 'age', text: '対象年齢は？' },
                    { id: 'cost', text: '費用について教えて' },
                    { id: 'trial', text: '体験はできる？' }
                ]
            },
            enjoy: {
                user: "うちの子でも楽しめる？",
                bot: "もちろん楽しめます！\n\nキープオンでは、ブロック、パズル、ゲーム、ロボットなど、わくわくするカリキュラムをご用意しています。\n\n遊び要素がたっぷりで、好奇心のまま夢中で取り組めるんです。実際、多くの子どもたちが「勉強」というより「遊び」の感覚で通っています。\n\n夢中になってつくることで物事を理解し、それが自信につながります。自信がつくから続けられて、続けることで成長を実感できる。そんな好循環が生まれるんです。",
                questions: [
                    { id: 'pace', text: '授業についていけるか心配...' },
                    { id: 'support', text: 'サポート体制は？' },
                    { id: 'class', text: 'クラスの雰囲気は？' },
                    { id: 'parent', text: '保護者のサポートは必要？' }
                ]
            },
            beginner: {
                user: "プログラミング未経験でも大丈夫？",
                bot: "はい、まったく問題ありません！\n\nほとんどのお子さまが初心者からスタートしています。\n\n小学生でも理解できるビジュアルプログラミングを使うので、ドラッグ＆ドロップで直感的にプログラミングできます。\n\nパソコンの基本操作から丁寧にサポートしますし、ステップアップ式のカリキュラムで、自分のペースで無理なく学べる環境を整えています。\n\n大切なのは「やってみたい」という気持ちだけです！",
                questions: [
                    { id: 'curriculum', text: 'どんなことから始めるの？' },
                    { id: 'homework', text: '宿題はある？' },
                    { id: 'schedule', text: 'スケジュールは？' },
                    { id: 'trial', text: '体験で雰囲気を見たい' }
                ]
            },
            skills: {
                user: "どんな力が身につくの？",
                bot: "プログラミング技術はもちろんですが、それ以上に大切な力が身につきます。\n\n1. 自分で考える力：問いを立てて、試行錯誤しながら答えを見つける\n2. 伝える力：作った作品を自分の言葉で発表する経験を重ねる\n3. 協力する力：仲間と対話しながら、より良いものを作る\n4. 続ける力：自分で選んだことに責任を持って取り組む\n\nこれらは、どんな時代、どんな職業でも通用する普遍的な力です。\n\n進学や就職だけでなく、その先の人生を豊かに生きるための土台となります。",
                questions: [
                    { id: 'future', text: '将来どう役立つ？' },
                    { id: 'event', text: '発表会などはある？' },
                    { id: 'graduate', text: '卒業後も学べる？' },
                    { id: 'achievement', text: '成果を実感できる？' }
                ]
            },
            different: { // ★変更点: ここのquestionsに新しい質問を追加
                user: "他のスクールとの違いは？",
                bot: "最大の違いは「教え方」です。\n\n一般的なスクールでは、先生が正解を教えて、生徒がそれを覚える形が多いですよね。\n\nでもキープオンでは、私たちから正解を与えることはしません。代わりに「どう思う？」「なんでそう思うの？」と問いかけることで、子どもたち自身が考え、答えを見つけていきます。\n\nまた、毎週「だれでもYononaka」という時間があり、正解のないお題について自分の意見を作る練習もしています。\n\nこうした対話と探究を通じて、自律的に学ぶ力を育てているんです。",
                questions: [
                    { id: 'method', text: '具体的な授業の進め方は？' },
                    { id: 'teacher', text: '先生はどんな人？' },
                    { id: 'why_yononaka_importance', text: 'なぜYononakaで「正解のない問い」に取り組むの？' }, // ← 追加した質問
                    { id: 'cost', text: '費用について教えて' },
                    { id: 'online_option', text: 'オンライン対応は？' }
                ]
            },
            // ★追加: Yononakaで「正解のない問い」に向き合う理由の説明
            why_yononaka_importance: {
                user: "なぜYononakaで「正解のない問い」に取り組むの？",
                bot: "それは、これからの時代を生きる子どもたちにとって、とても大切な力を育むためなんです。\n\n" +
                     "🧠 **学校と実社会の違い**\n" +
                     "学校では「正しい答え」がある問題に多く取り組みますが、実社会や人生には、たった一つの正解がない問いの方がずっと多いんです。\n" +
                     "例えば、「友達と意見が合わない時、どうする？」や「何を選んで買うか？」といった日常の選択から、「将来どんな仕事をしたいか？」といった大きな問いまで、テストのような100点の答えはありません。\n" +
                     "だからこそ、自分の頭で考え、他の人と意見を交わしながら、自分なりの納得解を見つける力が必要になります。\n\n" +
                     "📱 **情報があふれる現代**\n" +
                     "今の子供たちは、スマートフォンやインターネットが当たり前の環境で育っています。情報は簡単に手に入りますが、その反面、何が本当に大切で、どれを信じればいいのか、見極めるのが難しくなっています。\n" +
                     "このような時代には、誰かから与えられた「正解」に頼るのではなく、自分自身の価値観や判断基準で考える習慣が、ますます重要になってくるんです。\n\n" +
                     "🌍 **変化の激しい時代に必要な力**\n" +
                     "技術の進化は目覚ましく、社会のあり方も多様化しています。AIと共に働く未来、環境問題への対応など、子どもたちはこれまでの常識が通用しないような、新しい課題に直面していくでしょう。\n" +
                     "「AIとどう協力していく？」「自分らしさって何だろう？」こうした問いに、決まった答えやマニュアルはありません。\n" +
                     "しかし、自分の頭で考え、自分の言葉で表現し、他の人と対話を重ねることで、一歩ずつ「自分なりの答え」に近づいていくことができます。\n\n" +
                     "💡 **だから、Yononakaでは…**\n" +
                     "私たちは、Yononakaという時間を通じて、「正解のない問いに向き合う習慣」を子どもたちの日常に取り入れたいと考えています。\n" +
                     "それによって育まれる思考力、対話力、判断力、共感力といった力は、学力だけでなく、これからの社会をしなやかに、そして力強く生き抜くための大切な土台になると信じています。",
                questions: [
                    { id: 'method', text: 'Yononakaの具体的な進め方は？' },
                    { id: 'skills', text: '他にどんな力が身につくの？' },
                    { id: 'trial', text: '体験してみたい' },
                    { id: 'initial', text: '最初の質問に戻る' }
                ]
            },
            age: {
                user: "対象年齢は？",
                bot: "小学生から中学生が中心ですが、「やってみたい」という気持ちがあれば、学年は問いません。\n\n実際に、小学1年生から中学3年生まで、幅広い年齢の子どもたちが一緒に学んでいます。\n\n異年齢での学び合いも、キープオンの特徴のひとつ。年上の子が年下の子をサポートしたり、年下の子の斬新なアイデアに年上の子が刺激を受けたり。\n\nそんな環境が、社会性を育む良い機会になっています。",
                questions: [
                    { id: 'level', text: '学年別のクラス分けは？' },
                    { id: 'highschool', text: '高校生以上も可能？' },
                    { id: 'trial', text: '体験で確認したい' },
                    { id: 'schedule', text: '通える時間帯は？' }
                ]
            },
            cost: {
                user: "費用について教えて",
                bot: "費用はコースによって異なりますが、月2回の授業が基本となっています。\n\n兄弟割引もご用意していますし、複数講座の受講も可能です。\n\nお支払い方法は、現金、口座振替、PayPay残高決済からお選びいただけます。\n\n入退会は自由で、違約金などは一切ありません。\n\n詳しい料金表は、ホームページでご確認いただくか、無料体験の際に詳しくご説明させていただきます。",
                questions: [
                    { id: 'trial', text: '無料体験はある？' },
                    { id: 'material', text: '教材費は別？' },
                    { id: 'discount', text: '割引制度について' },
                    { id: 'contact', text: '詳しく相談したい' }
                ]
            },
            trial: {
                user: "体験はできる？",
                bot: "はい！無料体験を実施しています。\n\n体験だけの参加も大歓迎です。実際の授業の雰囲気を感じていただけるよう、通常の授業と同じ内容を体験していただけます。\n\n持ち物は一切不要。手ぶらでお越しください！体験キットやパソコンはすべてこちらでご用意します。\n\n体験後に無理な勧誘などは一切ありませんので、安心してお子さまに合うかどうかをじっくりご検討ください。",
                questions: [
                    { id: 'apply', text: '体験に申し込みたい！' },
                    { id: 'schedule', text: '体験できる日時は？' },
                    { id: 'parent_join', text: '保護者も見学できる？' },
                    { id: 'after_trial', text: '体験後の流れは？' }
                ]
            },
            pace: {
                user: "授業についていけるか心配...",
                bot: "その心配は不要です！\n\nキープオンでは、一人ひとりのペースを大切にしています。ステップアップ式のカリキュラムで、理解度に合わせて進められます。\n\n分からないことがあれば、スタッフがすぐにサポート。1クラス12名までの少人数制で、複数のスタッフが見守っているので、きめ細かなフォローができます。\n\nまた、欠席した場合は振替受講も可能。無理なく続けられる環境を整えています。",
                questions: [
                    { id: 'support', text: 'どんなサポートがある？' },
                    { id: 'class', text: 'クラスの雰囲気は？' },
                    { id: 'trial', text: '体験で確認したい' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            apply: {
                user: "体験に申し込みたい！",
                bot: "ありがとうございます！\n\n無料体験のお申し込みは、下のボタンからGoogleフォームにて受け付けています。\n\nお申し込み後、担当者から日程調整のご連絡をさせていただきます。\n\n体験当日は、お子さまの「やってみたい」という気持ちだけお持ちください。きっと楽しい時間になると思います！\n\nご不明な点があれば、お気軽にお問い合わせくださいね。",
                questions: [
                    { id: 'contact_form_link', text: '申し込みフォームへ' },
                    { id: 'more_info_link', text: 'もっと詳しく知りたい' },
                    { id: 'initial', text: '最初の質問に戻る' }
                ]
            },
            support: {
                user: "サポート体制は？",
                bot: "充実したサポート体制を整えています！\n\n1. 少人数制：1クラス12名までで、複数のスタッフがサポート\n2. 個別フォロー：つまずいているところを見逃さず、すぐにサポート\n3. 振替制度：欠席時も安心の振替受講が可能\n4. 保護者連携：LINEで授業の様子を動画でお送りします\n5. 質問対応：授業外でも質問を受け付けています\n\n「できない」を「できる」に変える瞬間を、スタッフ全員で支えます！",
                questions: [
                    { id: 'parent', text: '保護者の関わり方は？' },
                    { id: 'class', text: 'クラスの雰囲気は？' },
                    { id: 'trial', text: '体験で確認したい' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            class: {
                user: "クラスの雰囲気は？",
                bot: "とってもアットホームで楽しい雰囲気です！\n\n子どもたちは「先生」というより「一緒に考えてくれるお兄さん・お姉さん」という感覚でスタッフと接しています。\n\n異年齢の子どもたちが助け合いながら学ぶので、自然と協力する力も身につきます。\n\n「間違えてもいい」「人と違ってもいい」という安心感があるから、みんな自由に発想を広げています。\n\n笑い声が絶えない、そんな教室です！",
                questions: [
                    { id: 'event', text: 'イベントなどは？' },
                    { id: 'achievement', text: '子どもたちの成果は？' },
                    { id: 'trial', text: '実際に見てみたい' },
                    { id: 'initial', text: '最初の質問に戻る' }
                ]
            },
            parent: {
                user: "保護者のサポートは必要？",
                bot: "プログラミングの知識は一切必要ありません！\n\nお願いしたいのは、お子さまの「今日こんなの作ったよ！」という話を聞いてあげること。\n\n「どうやって作ったの？」「なんでそうしたの？」と聞いてあげるだけで、お子さまの思考はさらに深まります。\n\n授業の様子はLINEで動画をお送りするので、ご家庭でも話題にしていただけます。\n\n一緒に楽しんでいただけることが、何よりのサポートです！",
                questions: [
                    { id: 'report', text: '授業の様子を知る方法は？' },
                    { id: 'homework', text: '家での課題は？' },
                    { id: 'consultation', text: '相談できる？' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            curriculum: {
                user: "どんなことから始めるの？",
                bot: "最初は楽しいところから始めます！\n\n1. パソコンの基本操作（マウスやキーボード）\n2. ブロックを組み立てて簡単なロボット作り\n3. 信号機など身近なものの仕組みを学ぶ\n4. ビジュアルプログラミングで動かしてみる\n5. 自分のアイデアを加えてアレンジ\n\nいきなり難しいことはしません。「できた！」という成功体験を積み重ねながら、少しずつステップアップしていきます。\n\n大切なのは楽しむこと。楽しいから続く、続くから成長する！",
                questions: [
                    { id: 'language', text: '使うプログラミング言語は？' },
                    { id: 'project', text: 'どんな作品を作る？' },
                    { id: 'trial', text: '体験してみたい' },
                    { id: 'initial', text: '最初に戻る' }
                ]
            },
            homework: {
                user: "宿題はある？",
                bot: "強制的な宿題はありません！\n\nただし、「もっとやりたい！」という子には、自由課題をご用意しています。\n\n授業で作った作品を家でも再現してみたり、新しいアイデアを考えてきたり。それを次の授業で発表すると、みんなから「すごい！」と言われて、さらにやる気がアップ！\n\n「やらされる」のではなく「やりたい」から取り組む。それがキープオンスタイルです。",
                questions: [
                    { id: 'home_support', text: '家でのサポートは？' },
                    { id: 'schedule', text: '授業の頻度は？' },
                    { id: 'balance', text: '他の習い事との両立は？' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            schedule: {
                user: "スケジュールは？",
                bot: "基本は月2回、無理のないペースで通えます。\n\n平日の夕方や土曜日など、複数の時間帯をご用意しているので、他の習い事とも両立しやすいです。\n\n1回の授業は90分。集中力が続く、ちょうどいい長さです。\n\n欠席時は振替も可能なので、体調不良や学校行事があっても安心。\n\n詳しい時間割は、体験時にご相談ください。お子さまのスケジュールに合わせて調整します！",
                questions: [
                    { id: 'location', text: '教室の場所は？' },
                    { id: 'online_option', text: 'オンライン受講は？' },
                    { id: 'trial', text: '体験の予約をしたい' },
                    { id: 'initial', text: '最初に戻る' }
                ]
            },
            future: {
                user: "将来どう役立つ？",
                bot: "プログラミングスキルだけでなく、どんな職業でも必要な力が身につきます。\n\n例えば...\n・医師：患者さんの話を聞き、最適な治療法を考える\n・経営者：市場を分析し、新しいビジネスを創造する\n・教師：生徒一人ひとりに合った指導法を工夫する\n・エンジニア：課題を見つけ、技術で解決策を作る\n\nどの職業でも「考える力」「伝える力」「創る力」は必須。\n\nAI時代だからこそ、人間にしかできない創造的な仕事が重要になります。その土台を今から育てているんです！",
                questions: [
                    { id: 'graduate', text: '卒業生の進路は？' },
                    { id: 'achievement', text: '具体的な成果は？' },
                    { id: 'skills', text: '身につく力をもっと詳しく' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            event: {
                user: "発表会などはある？",
                bot: "年3回、ロボット発表会を開催しています！\n\nテーマに沿って、オリジナルロボットを製作。例えば「便利な生活ロボット」「未来の乗り物」など。\n\n子どもたちは数週間かけて準備し、当日は保護者の前で堂々と発表！最初は恥ずかしがっていた子も、回を重ねるごとに自信満々に。\n\nまた、「だれでもYononaka」では、正解のないお題についてみんなで意見交換。\n\nこうした経験が、人前で話す力や、自分の考えを伝える力を育てます！",
                questions: [
                    { id: 'weekly', text: '普段の授業での発表は？' },
                    { id: 'community', text: '他の生徒との交流は？' },
                    { id: 'achievement', text: '発表会の成果は？' },
                    { id: 'initial', text: '最初に戻る' }
                ]
            },
            graduate: {
                user: "卒業後も学べる？",
                bot: "もちろんです！卒業は「新たな学びの始まり」です。\n\n卒業後は...\n・PBL（課題解決型学習）コースでさらに深い学びへ\n・Yononakaなどのイベントに参加\n・スクールのアシスタントとして後輩をサポート\n・オンラインコミュニティで情報交換\n\n実際、高校生になってもイベントに顔を出してくれる子や、大学でロボット工学を専攻する子も。\n\n「学び続ける」というキープオンの理念は、卒業後も続いていきます！",
                questions: [
                    { id: 'alumni', text: '卒業生の活躍は？' },
                    { id: 'advanced', text: '上級コースについて' },
                    { id: 'community', text: 'コミュニティについて' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            achievement: {
                user: "成果を実感できる？",
                bot: "はい、必ず実感していただけます！\n\n3ヶ月後：「できた！」が増えて、自信がつく\n6ヶ月後：自分のアイデアを形にできるように\n1年後：堂々と発表できる姿に成長\n\n保護者の方からは...\n「学校の発表でも積極的に手を挙げるようになった」\n「自分で考えて行動することが増えた」\n「難しいことにも諦めずに挑戦するようになった」\n\nという嬉しい声をたくさんいただいています。\n\n毎回の授業動画で、成長の過程も見守れます！",
                questions: [
                    { id: 'voice', text: '他の保護者の声は？' },
                    { id: 'trial', text: '実際に体験したい' },
                    { id: 'apply', text: '申し込みたい！' },
                    { id: 'initial', text: '最初に戻る' }
                ]
            },
            method: {
                user: "具体的な授業の進め方は？",
                bot: "90分の授業はこんな流れです：\n\n1. だれでもYononaka（10分）\n   正解のないお題について意見を書く\n\n2. 今日のテーマ確認（10分）\n   何を作るか、どんな仕組みか理解\n\n3. 製作タイム（60分）\n   動画を見ながら自分のペースで製作\n   分からないところはスタッフがサポート\n\n4. 発表タイム（10分）\n   作った作品を自分の言葉で説明\n\nポイントは「教えすぎない」こと。\n子どもが自分で気づき、学ぶ瞬間を大切にしています！",
                questions: [
                    { id: 'material', text: '使う教材は？' },
                    { id: 'teacher', text: 'スタッフについて' },
                    { id: 'trial', text: '授業を体験したい' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            teacher: {
                user: "先生はどんな人？",
                bot: "「先生」というより「学びのパートナー」です！\n\n私たちスタッフは、答えを教える存在ではなく、一緒に考え、子どもたちの「なぜ？」「どうして？」に寄り添う存在。\n\nプログラミングの専門知識はもちろん、子どもたちの個性を大切にし、それぞれのペースに合わせたサポートができるよう研修を重ねています。\n\n「できない」と言う子には「一緒に考えよう」\n「分からない」と言う子には「どこまで分かった？」\n\nそんな声かけで、子どもたちの自律的な学びを支えています！",
                questions: [
                    { id: 'ratio', text: '先生と生徒の比率は？' },
                    { id: 'training', text: 'スタッフの研修は？' },
                    { id: 'support', text: 'サポート体制について' },
                    { id: 'initial', text: '最初に戻る' }
                ]
            },
            location: {
                user: "教室の場所はどこですか？",
                bot: "私たちの教室は[ここに教室の場所やアクセス情報を記述]にあります。詳細なアクセス方法はウェブサイトでもご確認いただけます。\n（この部分は実際の教室情報に置き換えてください）",
                questions: [
                    { id: 'online_option', text: 'オンライン対応は？' },
                    { id: 'facility', text: '教室の設備は？' },
                    { id: 'trial', text: '見学したい' },
                    { id: 'initial', text: '他の質問を見る' }
                ]
            },
            online_option: {
                 user: "オンライン対応は？",
                 bot: "はい、オンラインにも対応しています！\n\n基本的にはリアルな教室での授業が中心ですが、以下のプログラムはオンラインでも参加可能です：\n\n・Yononaka（対話型プログラム）\n・特別イベント\n・個別相談\n\nまた、遠方の方や、一時的に通えない場合のオンライン振替も検討可能です。\n\n教室の「みんなで学ぶ」雰囲気も大切にしながら、柔軟に対応させていただきます！",
                 questions: [
                     { id: 'location', text: '教室の場所は？' },
                     { id: 'trial', text: '体験してみたい' },
                     { id: 'initial', text: '他の質問を見る' }
                 ]
            }
            // 他の既存の会話データはそのまま
        };

        // (元のJavaScriptコードの続きは変更なし)
        // ...
        let isBotTyping = false;

        // DOM要素
        const chatArea = document.getElementById('chatArea');
        const questionButtonsContainer = document.getElementById('questionButtons');
        const characterUploadInput = document.getElementById('character-upload');
        const characterImagePreview = document.getElementById('character-image');
        const characterPlaceholder = document.querySelector('.character-placeholder');

        let defaultBotAvatarSrc = ''; // 現在のボットアバターのURLを保持

        // キャラクター画像のアップロード処理
        characterUploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageUrl = event.target.result;
                    characterImagePreview.src = imageUrl;
                    characterImagePreview.style.display = 'block';
                    characterPlaceholder.style.display = 'none';
                    updateDefaultBotAvatar(imageUrl); // 新しい画像をデフォルトとして設定

                    // 表示済みのボットアバターも更新
                    document.querySelectorAll('.bot-avatar img.dynamic-avatar').forEach(img => {
                        img.src = imageUrl;
                    });
                };
                reader.readAsDataURL(file);
            } else if (file) {
                alert("画像ファイルを選択してください。");
            }
        });

        // デフォルトのボットアバターURLを更新する関数
        function updateDefaultBotAvatar(src = '') {
            defaultBotAvatarSrc = src;
        }


        // メッセージをチャットエリアに追加する関数
        function addMessage(type, content, callback) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message ${type}`;

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message-content';

            if (type === 'bot') {
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'bot-avatar';

                if (defaultBotAvatarSrc) {
                    const img = document.createElement('img');
                    img.src = defaultBotAvatarSrc;
                    img.alt = "ボットアバター";
                    img.classList.add("dynamic-avatar");
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = '🤖';
                }
                messageWrapper.appendChild(avatarDiv);
                messageWrapper.appendChild(messageContentDiv);

                chatArea.appendChild(messageWrapper);
                scrollChatToBottom();

                isBotTyping = true;
                toggleQuestionButtons(true);
                showTypingIndicator(messageContentDiv, () => {
                    // 絵文字を活かすために、HTMLエンティティへの変換は行わず、\nを<br>に置換するのみ
                    messageContentDiv.innerHTML = content.replace(/\n/g, '<br>');
                    isBotTyping = false;
                    // ボタンの有効化は handleQuestion 内のコールバックで実行
                    if (callback) callback();
                    scrollChatToBottom();
                });
            } else { // User message
                messageContentDiv.innerHTML = content.replace(/\n/g, '<br>');
                messageWrapper.appendChild(messageContentDiv);
                chatArea.appendChild(messageWrapper);
                scrollChatToBottom();
                if (callback) callback();
            }
        }

        // タイピングインジケーターを表示
        function showTypingIndicator(messageContentElement, callback) {
            messageContentElement.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            scrollChatToBottom();
            setTimeout(callback, 1200 + Math.random() * 800);
        }

        // 質問ボタンを更新
        function updateQuestions(questions) {
            questionButtonsContainer.innerHTML = '';
            if (!questions || questions.length === 0) {
                const noMoreQuestionsButton = document.createElement('button');
                noMoreQuestionsButton.className = 'question-btn';
                noMoreQuestionsButton.textContent = '最初の質問に戻る';
                noMoreQuestionsButton.onclick = () => handleQuestion('initial');
                questionButtonsContainer.appendChild(noMoreQuestionsButton);
                return;
            }

            questions.forEach(q => {
                const button = document.createElement('button');
                button.className = 'question-btn';
                button.textContent = q.text;
                if (q.id) {
                    button.onclick = () => handleQuestion(q.id);
                } else {
                    console.warn("質問データにIDがありません:", q);
                    button.disabled = true;
                }
                button.disabled = isBotTyping;
                questionButtonsContainer.appendChild(button);
            });
        }

        // 質問ボタンを無効化/有効化
        function toggleQuestionButtons(disabled) {
            questionButtonsContainer.querySelectorAll('.question-btn').forEach(btn => {
                btn.disabled = disabled;
            });
        }

        // 質問を処理
        function handleQuestion(questionId) {
            if (isBotTyping) return;

            // 特別なリンク処理を先に行う
            if (questionId === 'contact_form_link') {
                window.open('https://docs.google.com/forms/d/e/1FAIpQLScqAKJ3CgsLb-COaE_fqsUwVGKcoiab21a3f5KrLYEzDHNzVQ/viewform', '_blank', 'noopener,noreferrer');
            } else if (questionId === 'more_info_link') {
                window.open('https://www.keeponlearning.fun/', '_blank', 'noopener,noreferrer');
            }

            const data = chatData[questionId];
            if (!data) {
                console.error(`質問IDに対応するチャットデータが見つかりません: ${questionId}`);
                addMessage('bot', '申し訳ありません、その質問には現在お答えできません。他の質問を選んでいただけますか？', () => {
                    updateQuestions(chatData.initial.questions);
                    toggleQuestionButtons(false);
                });
                return;
            }

            toggleQuestionButtons(true);

            if (data.user) {
                addMessage('user', data.user, () => {
                    setTimeout(() => {
                        addMessage('bot', data.bot, () => {
                            updateQuestions(data.questions);
                            toggleQuestionButtons(false);
                        });
                    }, 400 + Math.random() * 400);
                });
            } else {
                 addMessage('bot', data.bot, () => {
                    updateQuestions(data.questions);
                    toggleQuestionButtons(false);
                });
            }
        }

        // チャットエリアを一番下にスクロール
        function scrollChatToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 初期化関数
        function init() {
            const initialData = chatData.initial;
            if (initialData) {
                setTimeout(() => {
                    addMessage('bot', initialData.bot, () => {
                        updateQuestions(initialData.questions);
                        toggleQuestionButtons(false);
                    });
                }, 700);
            } else {
                console.error("初期チャットデータが見つかりません!");
            }
            updateDefaultBotAvatar(characterImagePreview.src && characterImagePreview.style.display === 'block' ? characterImagePreview.src : '');
        }

        // DOMContentLoaded後に関数を実行
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
